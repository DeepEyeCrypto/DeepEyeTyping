name: Quality Gate

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Type Check (Fast)
        run: npm run typecheck 2>&1 || true

      - name: Neural Lint (Performance & Standards)
        run: npm run lint

      - name: Neural Synchronization Tests (32 Core Tests)
        run: npm run test --workspace=core

      - name: Build Desktop (Tauri Payload)
        run: npm run build --workspace=desktop

      - name: Cross-Package Validation (Web)
        run: npm run build --workspace=web

      - name: Verify Performance Budget - Main Bundle
        run: |
          # Check main index file size
          MAIN_JS=$(ls apps/desktop/dist/assets/index-*.js 2>/dev/null | head -n 1)
          if [ -z "$MAIN_JS" ]; then
            echo "No main JS found, checking alternative pattern..."
            MAIN_JS=$(find apps/desktop/dist -name "*.js" -type f | head -n 1)
          fi
          SIZE=$(stat -c%s "$MAIN_JS")
          MAX_SIZE=120000
          
          echo "Main Bundle Size: $SIZE bytes (max: $MAX_SIZE)"
          if [ "$SIZE" -gt "$MAX_SIZE" ]; then
            echo "ERROR: Main bundle exceeds budget ($SIZE > $MAX_SIZE)"
            exit 1
          fi

      - name: Verify Performance Budget - Vendor Chunks
        run: |
          # Check total vendor chunk sizes
          VENDOR_REACT=$(ls apps/desktop/dist/assets/vendor-react-*.js 2>/dev/null | head -n 1 || echo "")
          VENDOR_MOTION=$(ls apps/desktop/dist/assets/vendor-motion-*.js 2>/dev/null | head -n 1 || echo "")
          
          if [ -n "$VENDOR_REACT" ]; then
            SIZE=$(stat -c%s "$VENDOR_REACT")
            MAX=80000
            echo "Vendor React: $SIZE bytes (max: $MAX)"
            if [ "$SIZE" -gt "$MAX" ]; then
              echo "ERROR: React vendor chunk exceeds budget"
              exit 1
            fi
          fi
          
          if [ -n "$VENDOR_MOTION" ]; then
            SIZE=$(stat -c%s "$VENDOR_MOTION")
            MAX=60000
            echo "Vendor Motion: $SIZE bytes (max: $MAX)"
            if [ "$SIZE" -gt "$MAX" ]; then
              echo "ERROR: Framer Motion vendor chunk exceeds budget"
              exit 1
            fi
          fi
          echo "Vendor budgets cleared."

      - name: Check CSS Bundle Size
        run: |
          CSS_FILE=$(find apps/desktop/dist -name "*.css" -type f | head -n 1)
          if [ -n "$CSS_FILE" ]; then
            SIZE=$(stat -c%s "$CSS_FILE")
            MAX=50000
            echo "CSS Bundle: $SIZE bytes (max: $MAX)"
            if [ "$SIZE" -gt "$MAX" ]; then
              echo "WARNING: CSS bundle exceeds budget"
            fi
          fi
          echo "Bundle validation complete."
